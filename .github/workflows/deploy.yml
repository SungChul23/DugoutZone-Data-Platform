name: Dugout Backend CI/CD

on:
  push:
    branches: [ "main" ] # main 브랜치에 push될 때마다 실행

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: 체크아웃 소스코드
      uses: actions/checkout@v4

    - name: JDK 17 설정 (버전에 맞춰 수정)
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Gradle 빌드 권한 부여
      run: chmod +x gradlew

    - name: Gradle로 빌드 실행
      run: ./gradlew clean build -x test # 테스트는 일단 제외하고 빌드

    - name: 빌드된 JAR 파일을 EC2로 전송 (SCP)
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "build/libs/*.jar,!build/libs/*-plain.jar"
        target: "/home/ubuntu/dugout/tars"
        strip_components: 2

    - name: EC2에서 서버 재시작 (SSH)
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # 기존 실행 중인 서버 종료
          fuser -k 8080/tcp || true

          # 기존 JAR 파일 삭제 (중복 실행 방지)
          # 새로 전송된 JAR만 남기기 위해 기존 파일을 지워줍니다.
          rm -f /home/ubuntu/dugout/*.jar 

          # 전송된 폴더에서 실행 폴더로 JAR 이동
          cp /home/ubuntu/dugout/tars/*.jar /home/ubuntu/dugout/app.jar
          
          # 3. 새 서버 실행 (DB + Athena 환경 변수 주입)
          # 여기서 ${{ secrets.XXX }} 부분은 깃허브 저장소에 설정한 이름과 일치해야 합니다.
          nohup /usr/bin/java -jar /home/ubuntu/dugout/app.jar \
            --spring.datasource.url=${{ secrets.DB_URL }} \
            --spring.datasource.username=${{ secrets.DB_USERNAME }} \
            --spring.datasource.password=${{ secrets.DB_PASSWORD }} \
            --aws.athena.region=${{ secrets.AWS_ATHENA_REGION }} \
            --aws.athena.database=${{ secrets.AWS_ATHENA_DATABASE }} \
            --aws.athena.output-location=${{ secrets.AWS_ATHENA_OUTPUT_LOCATION }} \
            --naver.api.client-id=${{ secrets.NAVER_CLIENT_ID }} \
            --naver.api.client-secret=${{ secrets.NAVER_CLIENT_SECRET }} \
            --jwt.secret=${{ secrets.JWT_SECRET_KEY }} > /home/ubuntu/dugout/app.log 2>&1 &