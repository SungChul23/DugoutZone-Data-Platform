name: Dugout Backend CI/CD

on:
  push:
    branches: [ "main" ] # main 브랜치에 push될 때마다 실행

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: 체크아웃 소스코드
      uses: actions/checkout@v4

    - name: JDK 17 설정 (버전에 맞춰 수정)
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Gradle 빌드 권한 부여
      run: chmod +x gradlew

    - name: Gradle로 빌드 실행
      run: ./gradlew clean build -x test # 테스트는 일단 제외하고 빌드

    - name: 빌드된 JAR 파일을 EC2로 전송 (SCP)
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "build/libs/*.jar,!build/libs/*-plain.jar"
        target: "/home/ubuntu/dugout/tars"
        strip_components: 2

    - name: EC2에서 서버 재시작 (SSH)
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # 기존 실행 중인 서버 종료
          fuser -k 8080/tcp || true
          # 새 서버 실행 (환경 변수 주입)
          nohup /usr/bin/java -jar /home/ubuntu/dugout/tars/*.jar \
            --spring.datasource.url=${{ secrets.DB_URL }} \
            --spring.datasource.username=${{ secrets.DB_USERNAME }} \
            --spring.datasource.password=${{ secrets.DB_PASSWORD }} > /home/ubuntu/dugout/app.log 2>&1 &
